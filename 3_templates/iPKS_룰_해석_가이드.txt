===============================================================================
iPKS 룰 추출 - 해석 가이드
===============================================================================

날짜: 2025-10-13
파이프라인: syntemp_attempt2
결과물: 박테리아 iPKS 반응으로부터 추출된 36개 GML 룰 + 메타데이터

===============================================================================
요약
===============================================================================

성공: 박테리아 반복형 PKS 반응으로부터 36개 DPO 룰 추출 완료
  - 30개 연장 룰 (KS-AT, KS-AT-KR 도메인)
  - 6개 고리화 룰 (PT 도메인, C2-C7 aldol 고리화)
  - 모든 룰이 원본 SMILES 반응으로 검증됨

핵심 발견: 룰이 iPKS 특이적 화학을 정확히 포착
  1. 단일 모듈의 반복 사용 (같은 룰이 반복 적용됨)
  2. PT 도메인 고리화 (선형 폴리케타이드 → 방향족 고리)
  3. 유전자-룰 매핑을 위한 도메인별 메타데이터

===============================================================================
룰 목록
===============================================================================

총 36개 룰 (8개 박테리아 iPKS 유전자 클러스터로부터)

클러스터별:
  BGC1000000 (icmM):        5개 룰  [4 연장 + 1 고리화]
  BGC1000001 (SACE_5532):   5개 룰  [4 연장 + 1 고리화]
  BGC1000002 (AziB):        6개 룰  [5 연장 + 1 고리화]
  BGC1000003 (PorKM1):      4개 룰  [3 연장 + 1 고리화]
  BGC1000004 (CalO5):       3개 룰  [3 연장 + 0 고리화]
  BGC1000005 (ChlB1):       4개 룰  [3 연장 + 1 고리화]
  BGC1000006 (NcsB):        6개 룰  [5 연장 + 1 고리화]
  BGC1000007 (AviM):        3개 룰  [3 연장 + 0 고리화]

룰 타입별:
  연장 (EXT):         30개 룰  [KS-AT 도메인, 말로닐 축합]
  고리화 (CLOSURE):    6개 룰  [PT 도메인, 방향족 고리 형성]

===============================================================================
룰 구조: GML 형식
===============================================================================

각 룰은 3가지 구성요소로 이루어짐:

1. LEFT (반응물 패턴)
   - 반응 전 그래프 구조
   - 결합: "-" (단일결합), "=" (이중결합)
   - 원자: C, O, S 등

2. CONTEXT (변하지 않는 원자들)
   - 반응물과 생성물 모두에 존재하는 원자들
   - 패턴 매칭에 사용됨

3. RIGHT (생성물 패턴)
   - 반응 후 그래프 구조
   - 새로운 결합: ":" (방향족)

===============================================================================
예시 1: 연장 룰 (BGC1000000_m0_to_m1)
===============================================================================

메타데이터:
  reaction_id: BGC1000000_m0_to_m1
  domain: [KS, AT]
  substrate: malonyl
  rule_type: EXT
  origin: iPKS_bacterial

SMILES 반응식:
  반응물:  CC(=O)[S]              # 아세틸-티오에스터
  생성물:  CC(=O)CC(=O)[S]        # 아세토아세틸-티오에스터
  변화:    +C2O1 (말로닐 첨가, CO2 방출)

GML 해석:
  LEFT (반응물):
    C-C 결합
    C=O 결합 (케톤)
    C-S 결합 (티오에스터)
  
  RIGHT (생성물):
    C-C 결합 (유지)
    C=O 결합 (유지)
    C-C 결합 (신규 - 말로닐의 CH2)
    C-C 결합 (신규 - 말로닐)
    C=O 결합 (신규 - 말로닐의 케톤)
    C-S 결합 (신규 위치, 티오에스터 유지)

화학적 의미:
  - Claisen 축합: 아세틸 + 말로닐 → 아세토아세틸
  - 탄소 2개씩 사슬 연장
  - ACP와의 티오에스터 연결 유지
  - 이 정확한 패턴이 m1→m2, m2→m3, m3→m4에서 반복됨

포착된 iPKS 특징: 반복적 모듈 재사용

===============================================================================
예시 2: 고리화 룰 (BGC1000000_m4_to_m5)
===============================================================================

메타데이터:
  reaction_id: BGC1000000_m4_to_m5
  domain: [DH]  # 실제로는 PT 도메인 (DH로 표기됨)
  closure: PT_OR_TE
  rule_type: CLOSURE
  origin: iPKS_bacterial

SMILES 반응식:
  반응물:  CC(=O)CC(=O)CC(=O)CC(=O)CC(=O)[S]
           4개 케톤기, 선형 사슬 (펜타케타이드)
  
  생성물:  CC1=CC2=CC(=CC(=C2C(=O)O1)O)O
           이소쿠마린 고리, 방향족 (2,3-dehydro-6-hydroxymellein)
  
  변화:    선형 폴리케타이드 → 방향족 이환 구조

GML 해석:
  LEFT (반응물):
    긴 C-C 단일결합 사슬 ("-")
    여러 C=O 이중결합 ("=")
    모두 지방족 탄소 원자
  
  RIGHT (생성물):
    많은 C:C 방향족 결합 (":")
    2개 융합 고리 형성
    락톤 형성 (C(=O)O1)

화학적 의미:
  - PT 도메인이 C2-C7 aldol 고리화 촉매
  - 탈수 및 방향족화
  - 락톤화 (산소와 고리 닫힘)
  - 선형 → 고리형 변환

포착된 iPKS 특징: PT 도메인 위치선택적 고리화

메커니즘 세부사항:
  PT 도메인의 His949가 C2 양성자를 추출, C7 카보닐로 전달
  이것은 모듈형 PKS와는 다름 (PT 도메인 부재)
  이것이 반복형과 모듈형 PKS의 핵심 차이점

===============================================================================
예시 3: 환원 룰 (BGC1000001_m0_to_m1)
===============================================================================

메타데이터:
  reaction_id: BGC1000001_m0_to_m1
  domain: [KS, AT, KR]
  substrate: malonyl
  stereochem_tag: KR_unknown
  rule_type: EXT

SMILES 반응식:
  반응물:  CC(=O)[S]              # 아세틸 (케톤)
  생성물:  CC(O)CC(=O)[S]         # β-히드록시 생성물
  변화:    케톤 → 알코올 (KR 환원)

화학적 의미:
  - 연장 + 환원이 한 단계에서 발생
  - KR 도메인이 β-케톤을 β-히드록시로 환원
  - 입체화학 결과 미상 (A/B 배치 표기 없음)

포착된 iPKS 특징: 연장 중 선택적 환원

===============================================================================
룰 해석 방법
===============================================================================

1단계: 메타데이터 파일 읽기 (.meta.json)

  주요 필드:
    "rule_type":   "EXT" 또는 "CLOSURE"
    "domain":      어떤 PKS 도메인이 활성화되어 있는가
    "closure":     이것이 종결 단계인가?
    "substrate":   어떤 빌딩 블록이 추가되는가

2단계: 룰 범주 식별

  연장 룰:
    - domain에 "KS"와 "AT" 포함
    - rule_type = "EXT"
    - closure가 비어있음
    → 이들은 C2 단위를 추가 (말로닐-CoA)

  고리화 룰:
    - domain에 "DH" 포함 (실제로는 PT)
    - rule_type = "CLOSURE"
    - closure = "PT_OR_TE"
    → 이들은 방향족 고리 형성

  환원 룰:
    - domain에 "KR" 포함
    - rule_type = "EXT"
    - 케톤 (C=O) → 알코올 (C-OH)

3단계: GML에서 결합 변화 확인

  연장 패턴:
    LEFT:  n개 원자
    RIGHT: n+3개 원자 (대략)
    신규:  C-C-C(=O) 추가됨

  고리화 패턴:
    LEFT:  "-"와 "=" 결합 (지방족)
    RIGHT: ":" 결합 (방향족)
    신규:  고리 형성

4단계: 원본 SMILES로 검증

  파일: 1_preprocessing/data/iPKS_rxn.reactions.labeled.csv
  reaction_id를 매칭하여 룰 정확성 확인

===============================================================================
룰이 포착한 iPKS 특징
===============================================================================

특징 1: 반복 논리
  증거: BGC1000000_m0_to_m1부터 m3_to_m4까지의 룰들
        동일한 GML 패턴, 다른 중간체
  의미: 같은 KS-AT 모듈이 반복적으로 사용됨
  상태: ✓ 포착됨

특징 2: 기질 특이성
  증거: 모든 연장 룰이 substrate = "malonyl"
        프로피오닐, 메틸말로닐 없음
  의미: 박테리아 iPKS는 말로닐-CoA만 사용
  상태: ✓ 포착됨

특징 3: PT 도메인 고리화
  증거: m4_to_m5, m5_to_m6 룰에 closure = "PT_OR_TE"
        GML이 "-" → ":" 결합 변환 표시
  의미: C2-C7 aldol 고리화 + 방향족화
  상태: ✓ 포착됨

특징 4: 종결 논리
  증거: 최종 고리화 단계에 "PT_OR_TE" 태그
  의미: 폴리케타이드 조립의 끝 표시
  상태: ✓ 포착됨 (메타데이터로)

특징 5: 선택적 환원
  증거: 일부 룰이 domain = [KS, AT, KR]
        SMILES가 C=O → C-OH 변환 표시
  의미: KR 도메인이 어떤 사이클에서는 활성, 어떤 사이클에서는 비활성
  상태: ✓ 포착됨

===============================================================================
품질 평가
===============================================================================

정확도:
  ✓ 36개 룰 모두 원본 SMILES로 검증됨
  ✓ 화학량론 오류 없음
  ✓ 결합 변화가 예상 화학과 일치

완전성:
  ✓ 연장 반응: 30/30 포착
  ✓ 고리화 반응: 6/6 포착
  ✓ 환원 변이형: KR 포함 모듈 모두 포착

메타데이터:
  ✓ 도메인 표기 정확
  ✓ 기질 정보 정확
  ✓ Closure 플래그 적절히 할당
  ✓ 출처 추적 가능 (BGC ID 보존됨)

iPKS 특이성:
  ✓ 룰 시퀀스에서 반복 패턴 가시화
  ✓ 고리화 룰에서 PT 도메인 메커니즘 포착
  ✓ 모듈형 PKS 룰과 차별화 (C4-C9 고리화 없음)

===============================================================================
비교: iPKS vs 모듈형 PKS 룰
===============================================================================

iPKS 룰 (이 데이터셋):
  - 같은 룰이 여러 번 적용됨 (반복)
  - PT 도메인 고리화 (C2-C7)
  - 방향족 생성물 (벤젠 고리)
  - 박테리아 출처

모듈형 PKS 룰 (만약 있다면):
  - 각 모듈이 다른 룰 사용 (조립 라인)
  - TE 도메인 고리화 (매크로락톤)
  - 환원된 생성물 (방향족 적음)
  - 박테리아 출처

핵심 차이:
  iPKS: 한 모듈, 여러 사이클 → 방향족 폴리케타이드
  모듈형: 여러 모듈, 한 번 통과 → 매크롤라이드

===============================================================================
경로 재구성 예시: BGC1000000 (icmM)
===============================================================================

유전자 클러스터: icmM
생성물: 2,3-dehydro-6-hydroxymellein (이소쿠마린)

경로:
  단계 0: 아세틸-CoA 로딩
          SMILES: CC(=O)[S]

  단계 1: 연장 (룰: BGC1000000_m0_to_m1)
          SMILES: CC(=O)CC(=O)[S]
          도메인: KS-AT
          변화: +C2O1

  단계 2: 연장 (룰: BGC1000000_m1_to_m2)
          SMILES: CC(=O)CC(=O)CC(=O)[S]
          도메인: KS-AT
          변화: +C2O1

  단계 3: 연장 (룰: BGC1000000_m2_to_m3)
          SMILES: CC(=O)CC(=O)CC(=O)CC(=O)[S]
          도메인: KS-AT
          변화: +C2O1

  단계 4: 연장 (룰: BGC1000000_m3_to_m4)
          SMILES: CC(=O)CC(=O)CC(=O)CC(=O)CC(=O)[S]
          도메인: KS-AT
          변화: +C2O1

  단계 5: 고리화 (룰: BGC1000000_m4_to_m5)
          SMILES: CC1=CC2=CC(=CC(=C2C(=O)O1)O)O
          도메인: PT (DH로 표기됨)
          변화: C2-C7 aldol → 방향족 고리

관찰 사항:
  - 단계 1-4는 동일한 화학 사용 (반복)
  - 단계 5는 PT 도메인 사용 (iPKS 특유)
  - 총합: 1 시작 단위 + 4 연장 단위 = 펜타케타이드
  - 최종 생성물: 이소쿠마린 스캐폴드

이 경로는 모듈형 PKS로는 불가능
  이유: 모듈형 PKS는 C2-C7 고리화를 위한 PT 도메인 결여

===============================================================================
이 룰들로 할 수 있는 것
===============================================================================

가능한 응용:
  ✓ 정방향 합성 시뮬레이션 (MØD 사용)
  ✓ 역합성 경로 설계
  ✓ 유전자 클러스터 주석 (룰 → 유전자 매핑)
  ✓ ML 모델 훈련 데이터 (구조-활성)

사용 예시:
  입력:  타겟 이소쿠마린 구조
  방법: 룰을 순서대로 적용 (EXT → EXT → ... → CLOSURE)
  출력: 예측된 유전자 클러스터 구성

한계점:
  ✗ 템플릿 적용 논리 없음 (언제 어떤 룰을 사용할지?)
  ✗ 스캐폴드별 선택 없음 (이소쿠마린 vs 테트랄론)
  ✗ 게이트 시스템 없음 (생합성 순서 제약)

===============================================================================
경로 설계를 위한 다음 단계
===============================================================================

실제 경로 설계에 이 룰들을 사용하려면:

1. 게이트 시스템 구현
   목적: 각 단계에서 적용 가능한 룰 제어
   예시: EXT[0,5] → 연장 룰만, 최대 5회
         CYC[C2C7_PT] → PT 도메인 고리화 룰만
         TE[LAC] → 락톤화 룰만

2. 템플릿 선택기 구축
   목적: 타겟 구조에 따라 적절한 룰 선택
   방법: 타겟 분류 → 호환 룰 세트 선택
   예시: 이소쿠마린 → BGC1000000 룰 사용
         테트랄론 → 다른 고리화 룰 사용

3. 생합성 순서 정의
   목적: 생화학적으로 타당한 룰 시퀀스 강제
   제약: EXT가 CYC에 선행해야 함
        CYC가 TE에 선행해야 함
        CLOSURE를 두 번 적용할 수 없음

4. 경로 설계자와 통합
   목적: 완전한 모듈 문자열 생성
   출력: "AT-ACP | KS-AT-ACP | KS-AT-ACP | KS-AT-PT-ACP"

===============================================================================
파일 위치
===============================================================================

룰 파일:
  GML 파일:       3_templates/data/rules/*.gml
  메타데이터:     3_templates/data/rules/*.meta.json
  인덱스:         3_templates/data/rules_index.csv

검증 데이터:
  원본 반응:      1_preprocessing/data/iPKS_rxn.reactions.labeled.csv
  균형 반응:      2_balancing/data/syntemp_ready.csv

스크립트:
  전처리:         1_preprocessing/scripts/*.py
  균형 확인:      2_balancing/scripts/*.py
  룰 추출:        3_templates/scripts/01_aam_its_rules_complete.py

===============================================================================
용어 설명
===============================================================================

AAM (Atom-Atom Mapping, 원자-원자 매핑):
  반응물과 생성물 사이의 원자 대응 관계 할당

ACP (Acyl Carrier Protein, 아실 운반 단백질):
  티오에스터를 통해 성장 중인 폴리케타이드 사슬을 보유하는 도메인

DH (Dehydratase, 탈수효소):
  β-히드록시기로부터 물을 제거하는 도메인
  주의: iPKS에서는 종종 잘못 표기됨 - 실제로는 PT 도메인

DPO (Double Pushout, 이중 밀어내기):
  그래프 재작성 룰을 위한 수학적 형식

GML (Graph Modelling Language, 그래프 모델링 언어):
  DPO 룰을 인코딩하는 형식, MØD에서 읽을 수 있음

iPKS (Iterative Type I PKS, 반복형 제1형 PKS):
  단일 모듈을 여러 번 재사용하는 PKS

ITS (Imaginary Transition State, 가상 전이 상태):
  반응 중심의 그래프 표현

KR (Ketoreductase, 케토환원효소):
  케톤을 알코올로 환원하는 도메인 (β-케토 → β-OH)

KS (Ketosynthase, 케토합성효소):
  C-C 결합 형성을 촉매하는 도메인 (Claisen 축합)

MØD (Molecule Octet Datum):
  그래프 기반 반응 모델링 소프트웨어

PT (Product Template, 생성물 주형):
  iPKS에서 위치선택적 aldol 고리화를 제어하는 도메인
  DH와 진균 PT 사이의 진화적 중간체

티오에스터 (Thioester):
  성장 사슬과 운반 단백질 사이의 C(=O)-S-[ACP] 연결

===============================================================================
참고문헌
===============================================================================

SynTemp 논문:
  Phan et al. (2025) J. Chem. Inf. Model.
  "SynTemp: 효율적인 그래프 기반 반응 룰 추출"

박테리아 PT 도메인:
  Feng et al. Nature Communications
  "Streptomyces viridochromogenes PT 도메인 구조와 메커니즘"

iPKS 메커니즘:
  Crawford & Townsend (2010) Nat. Rev. Microbiol.
  "진균 방향족 폴리케타이드 형성에 대한 새로운 통찰"

